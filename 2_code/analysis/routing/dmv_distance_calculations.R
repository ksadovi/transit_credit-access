# Preliminaries --------
source("2_code/packages+defaults.R")
source("2_code/function_library/run_all_functions.R")
path_in = "3_output/cleaned_data/LODES/"
path_out = "3_output/"

# Creating centroids --------
# Pulling tracts from all DMV states
dmv_tracts <- map_dfr(c("DC", "MD", "VA", "WV"), ~{
  tracts(.x, cb = TRUE, year = 2020)
}, geometry = T) %>%
  st_transform(4326)

# Getting the CBSA boundary
dc_metro <- core_based_statistical_areas(cb = TRUE, year = 2020) %>%
  filter(str_detect(NAME, "Washington-Arlington-Alexandria, DC-VA-MD-WV")) %>%
  st_transform(4326)
dc_boundary = counties("District of Columbia", cb = T, year = 2020) %>% st_transform(4326)

# Filtering tracts by whether they're within the CBSA
dc_metro_tracts <- dmv_tracts[dc_metro, ]

# Creating centroids
# I need to double check that this is the correct way of finding centroids. 
dmv_tract_centroids = dc_metro_tracts %>% st_centroid() 

# Calculating distances --------
## No purple line --------
dmv_distances_prepurple = map_station_distances(dmv_tract_centroids, exclude = "Purple")
time_elapsed_prepurple = dmv_distances_prepurple[2]
dmv_distance_prepurple = dmv_distances_prepurple[1] %>% as.data.frame() %>% as_tibble %>% 
  mutate(min_dur = as.numeric(min_dur), 
         min_dist = as.numeric(min_dist))

fwrite(dmv_distance_prepurple, file = "3_output/cleaned_data/distance_calculations/DC_proper_no_purple.csv")

## Including purple line --------
dmv_distances_purple = map_station_distances(dmv_tract_centroids)
time_elapsed_purple = dmv_distances_purple[2]
dmv_distance_purple = dmv_distances_purple[1] %>% as.data.frame() %>% as_tibble %>% 
  mutate(min_dur = as.numeric(min_dur), 
         min_dist = as.numeric(min_dist))

fwrite(dmv_distances_purple, file = "3_output/cleaned_data/distance_calculations/DC_proper_purple.csv")

# Cleanup --------
# Removing all objects generated by this file that won't be necessary elsewhere
# rm(dc_metro, dc_metro_tracts, dmv_tract_centroids, dmv_tracts, dmv_distance, dmv_distances)